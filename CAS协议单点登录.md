# CAS协议、单点登录

#### 一. CAS协议

CAS协议是一种简单且功能强大的基于票证(ticket)的协议。它涉及一个或多个客户端和一台服务器。中央身份验证服务（CAS）是Web的单点登录/单点退出协议。用户向中央CAS Server应用程序提供一次凭据（例如用户ID和密码），就可以访问多个应用程序。  

##### 1.CAS特点

①开源的企业级单点登录解决方案。

①开源的企业级单点登录解决方案。

②CAS Server 为需要独立部署的 Web 应用。

③CAS Client 支持非常多的客户端(这里指单点登录系统中的各个 Web 应用)，包括 Java, .Net, PHP, Perl, Apache, uPortal, Ruby 等。

#####  2.CAS构成

CAS 包含两个部分： CAS Server 和 CAS Client。CAS Server 需要独立部署，主要负责对用户的认证工作；CAS Client 负责处理对客户端受保护资源的访问请求，需要登录时，重定向到 CAS Server。 

 ![](CAS协议、单点登录.assets/6.png)

#### 二. 单点登录

##### 1.概念

单点登录，简称为 SSO，是目前比较流行的业务整合的解决方案之一。SSO 的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。我们目前的系统存在诸多子系统，而这些子系统是分别部署在不同的服务器中，那么使用传统方式的 session 是无法解决的，我们需要使用相关的单点登录技术来解决。  

 ![](CAS协议、单点登录.assets/7.png)

##### 2.流程

第一步：用户访问应用系统1。过滤器判断用户是否登录，没有登录，则重定向到认证系统去进行认证操作。

第二步：重定向到认证系统，显示登录界面，用户输入用户名密码。认证系统将用户登录的信息记录到服务器的session中。 

第三步：认证系统给浏览器发送一个特殊的凭证ticket，浏览器将凭证交给应用系统1，应用系统1则拿着浏览器交给他的凭证ticket去认证系统验证凭证ticket是否有效。凭证ticket若是有效，将用户信息保存到应用系统1的session中一份，并告知应用系统1，用户通过认证。

第四步：用户通过认证，浏览器与网站之间进行正常的访问。 

第五步：当用户再次访问应用系统1，由于应用系统1的session中有用户信息，所以就不用经过认证系统认证，就可以直接访问应用系统1了。 

第六步：当用户再去访问其他应用系统时，浏览器会带着凭证ticket过去，其他应用系统到认证系统验证凭证，凭证ticket若是有效，将用户信息保存到其他应用系统的session中一份，并告知其他应用系统，用户通过认证。 

第七步：用户通过认证，浏览器与网站之间进行正常的访问。 第八步：当用户再次访问其他应用系统，由于其他应用系统的session中有用户信息，所以就不用经过认证系统认证，就可以直接访问其他应用系统了。 



#### 三. CAS详细登录流程 

![](CAS协议、单点登录.assets/8.png)

####  1.第一次访问

<1>：第一次访问时用户请求访问购物车，肯定先判断用户是否登录，如果没有登录则重定向到认证中心。

<2>：发现用户没有登录返回重定向地址（也就是到认证中心去）。

<3>：浏览器拿着重定向地址到认证中心发起认证请求。

<4>：认证中心收到请求，在浏览器显示登录界面。

<5>：用户输入用户名密码提交请求。

<6>：认证中心收到用户名密码，进行验证。回到浏览器并携带一个ticket令牌参数同时会在Cookie中设置一个TGC，该cookie是网站认证系统cas.xiaogui.com的cookie，只有访问这个网站才会携带这个cookie过去。 （TGC 以 cookie 的形式保存在浏览器中，每个请求都会尝试携带 TGC）

<7>：客户端（购物车）拿到ticket。

<8>：客户端向认证中心发送验证ticket的请求。

<9>：验证通过后会把用户信息保存在客户端的session中，并把客户端的SessionID设置在Cookie中，同时告知客户端ticket有效。当用户再次访问该客户端，就可以根据Cookie 中的SessionID找到客户端的Session，获取用户信息，就不用再次进行验证了。

<10>：购物车客户端收到认证通过后，知道用户已经登录，告知浏览器可以访问，进入购物车页面。 



##### 2.登录状态第二次访问

<11>：因客户端已经存了用户名和密码，浏览器中的cookie会根据SessionID找到Session获取用户信息，不用验证，直接可以访问。

<12>：客户端告知浏览器可以访问，进入购物车页面。 



##### 3.登录状态访问不同应用系统

<13>：用户发起对client（结算）请求。

<14>：客户端收到请求，发现第一次访问，于是让它重定向到认证中心登录。

<15>：浏览器发起重定向，因之前访问过认证中心，所以这次是带着上次返回的cookie：TGC到认证中心。<16>：认证中心收到请求，里面有对应的TGT，那就签发个凭证ticket，返回给浏览器。

<17>：浏览器重定向到客户端。

<18>：客户端带着凭证ticket去认证中心验证。

<19>：认证成功，用户信息保存到客户端session中。

<20>：告知浏览器可以访问。 



##### 4.名称解释：

**TGC：Ticket Granting Cookie**

CAS 会将生成的 TGT 放在 session 中，而 TGC 就是这个 session 的唯一标识(sessionId)，可以认为是 TGT 的key，为 TGT 就是 TGC 的 value，TGC 以 cookie 的形式保存在浏览器中，每个请求都会尝试携带 TGC。（每个服务都会在 session 和 cookie 中保存对应的 TGT 和 TGC）

**TGT：Ticket Granting Ticket**

TGT 是CAS 为用户签发的登录 ticket，也是用于验证用户登录成功的唯一方式。 TGT 封装了 Cookie 值以及 Cookie 值对应的用户信息，CAS 通过 Cookie 值（TGC）为 key 查询缓存中有无 TGT（TGC:TGT（key:value）），如果有的话就说明用户已经登录成。

**ST：Service Ticket**

ST 是当用户访问某一服务时提供的 ticket。用户在访问其他服务时，发现没有 cookie 或 ST ，那么就会302到 CAS 服务器获取 ST。然后会携带着 ST 302 回来。